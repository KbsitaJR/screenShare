<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <title>Compartir Pantalla</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; }
    video { width: 100%; max-width: 700px; margin-top: 20px; background: #000; border-radius: 8px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
    .status { margin: 10px 0; padding: 10px; background: #e0e0e0; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>📺 Compartir Pantalla entre Dispositivos</h1>
  <div>
    <button onclick="startShare()">🎥 Compartir Pantalla</button>
    <button onclick="startCamera()">📱 Compartir Cámara</button>
    <button onclick="startIOSScreenShare()" id="iosBtn" style="display:none">🍎 iOS Screen Share</button>
    <button onclick="startViewer()">👁️ Soy Receptor</button>
  </div>
  <div id="status" class="status">Haz clic en un botón para comenzar</div>
  <video id="video" autoplay playsinline muted></video>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDzlDO4On3rclaTyvZxF8mLzaXUsE5hick",
      authDomain: "sscreenshare-f9a07.firebaseapp.com",
      databaseURL: "https://sscreenshare-f9a07-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "sscreenshare-f9a07",
      storageBucket: "sscreenshare-f9a07.firebasestorage.app",
      messagingSenderId: "334641429960",
      appId: "1:334641429960:web:b4a17037ab372e1b0594fd",
      measurementId: "G-WS3GJVRJBH"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomId = "room123";
    const video = document.getElementById("video");
    const statusDiv = document.getElementById("status");

    let pc = new RTCPeerConnection({ 
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }] 
    });

    let role = null;

    // Función específica para iOS con workarounds
    async function startIOSScreenShare() {
      try {
        updateStatus("iOS detectado. Intentando métodos alternativos...");
        
        // Método 1: Intentar con getUserMedia de la cámara frontal
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        video.srcObject = stream;
        updateStatus("Usando cámara frontal. Para pantalla real: usa AirPlay + captura externa");
        
        // Mostrar instrucciones para iOS
        setTimeout(() => {
          alert(`📱 Para compartir pantalla real en iOS:
          
1. Activa Control Center
2. Toca "Grabación de pantalla" 
3. Selecciona esta app
4. O usa AirPlay para enviar a otro dispositivo`);
        }, 2000);
        
      } catch (error) {
        updateStatus("Error en iOS: " + error.message);
      }
    }

    // Función para detectir si iOS y sugerir alternativas
    function isiOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent);
    }

    // Función para verificar soporte de getDisplayMedia
    function supportsScreenShare() {
      return navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia;
    }

    // Función para compartir cámara (alternativa móvil)
    async function startCamera() {
      try {
        role = "sender";
        updateStatus("Iniciando cámara...");
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment' // Cámara trasera por defecto
          }, 
          audio: false 
        });
        
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        video.srcObject = stream;
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        db.ref(`${roomId}/offer`).set({
          type: offer.type,
          sdp: offer.sdp
        });
        
        updateStatus("Oferta creada. Esperando respuesta...");

        // Escuchar respuesta
        db.ref(`${roomId}/answer`).on("value", async snap => {
          if (snap.exists()) {
            const answer = new RTCSessionDescription(snap.val());
            await pc.setRemoteDescription(answer);
            updateStatus("Conexión establecida! Compartiendo cámara...");
          }
        });

      } catch (error) {
        console.error("Error al compartir cámara:", error);
        updateStatus("Error: " + error.message);
      }
    }

    // Manejo de ICE candidates
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        const candidate = {
          candidate: event.candidate.candidate,
          sdpMid: event.candidate.sdpMid,
          sdpMLineIndex: event.candidate.sdpMLineIndex
        };
        db.ref(`${roomId}/candidates/${role}`).push(candidate);
        updateStatus(`Enviando candidate (${role})`);
      }
    };

    // Escuchar candidates del viewer
    db.ref(`${roomId}/candidates/viewer`).on("child_added", snap => {
      if (role === "sender") {
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
        updateStatus("Candidate recibido del viewer");
      }
    });

    // Escuchar candidates del sender
    db.ref(`${roomId}/candidates/sender`).on("child_added", snap => {
      if (role === "viewer") {
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
        updateStatus("Candidate recibido del sender");
      }
    });

    // Función para actualizar el estado
    function updateStatus(message) {
      statusDiv.textContent = message;
      console.log(message);
    }

    // Función para compartir pantalla (Desktop/Android Chrome)
    async function startShare() {
      try {
        if (!supportsScreenShare()) {
          updateStatus("Tu navegador no soporta compartir pantalla. Usa 'Compartir Cámara' en su lugar.");
          return;
        }

        role = "sender";
        updateStatus("Iniciando compartir pantalla...");
        
        const stream = await navigator.mediaDevices.getDisplayMedia({ 
          video: true, 
          audio: false 
        });
        
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
        video.srcObject = stream;
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        db.ref(`${roomId}/offer`).set({
          type: offer.type,
          sdp: offer.sdp
        });
        
        updateStatus("Oferta creada. Esperando respuesta...");

        // Escuchar respuesta
        db.ref(`${roomId}/answer`).on("value", async snap => {
          if (snap.exists()) {
            const answer = new RTCSessionDescription(snap.val());
            await pc.setRemoteDescription(answer);
            updateStatus("Conexión establecida! Compartiendo pantalla...");
          }
        });

        // Manejar cuando se cierre la ventana de compartir
        stream.getVideoTracks()[0].onended = () => {
          updateStatus("Compartir pantalla terminado");
        };

      } catch (error) {
        console.error("Error al compartir pantalla:", error);
        updateStatus("Error: " + error.message);
        if (isMobile()) {
          updateStatus("En móviles, usa 'Compartir Cámara' en su lugar.");
        }
      }
    }

    // Función para ver pantalla compartida (Receptor)
    async function startViewer() {
      try {
        role = "viewer";
        updateStatus("Buscando pantalla compartida...");
        
        db.ref(`${roomId}/offer`).once("value").then(async snap => {
          const offer = snap.val();
          if (!offer) {
            updateStatus("No hay ofertas disponibles. Esperando...");
            return;
          }

          await pc.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          db.ref(`${roomId}/answer`).set({
            type: answer.type,
            sdp: answer.sdp
          });
          
          updateStatus("Respuesta enviada. Conectando...");
        });

        // Recibir stream
        pc.ontrack = (event) => {
          video.srcObject = event.streams[0];
          updateStatus("Conexión establecida! Viendo pantalla compartida...");
        };

        // Manejar desconexión
        pc.onconnectionstatechange = () => {
          updateStatus("Estado de conexión: " + pc.connectionState);
        };

      } catch (error) {
        console.error("Error al ver pantalla:", error);
        updateStatus("Error: " + error.message);
      }
    }

    // Función para detectar si es móvil
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Mostrar información sobre compatibilidad al cargar
    window.addEventListener('load', () => {
      db.ref(roomId).remove();
      
      if (isiOS()) {
        document.getElementById('iosBtn').style.display = 'inline-block';
        updateStatus("iOS detectado. Usa el botón específico para iOS o sigue las instrucciones");
      } else if (isMobile()) {
        if (supportsScreenShare()) {
          updateStatus("Android detectado. Puedes usar 'Compartir Pantalla' o 'Compartir Cámara'");
        } else {
          updateStatus("Móvil detectado. Usa 'Compartir Cámara'");
        }
      } else {
        updateStatus("Desktop detectado. Todas las funciones disponibles");
      }
    });
  </script>
</body>
</html>