<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compartir Pantalla</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; }
    video { width: 100%; max-width: 700px; margin-top: 20px; background: #000; border-radius: 8px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>ğŸ“º Compartir Pantalla entre Dispositivos</h1>
  <div>
    <button onclick="startShare()">ğŸ¥ Soy Emisor</button>
    <button onclick="startViewer()">ğŸ‘ï¸ Soy Receptor</button>
  </div>
  <video id="video" autoplay playsinline muted></video>

  <script>
      // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDzlDO4On3rclaTyvZxF8mLzaXUsE5hick",
    authDomain: "sscreenshare-f9a07.firebaseapp.com",
    databaseURL: "https://sscreenshare-f9a07-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "sscreenshare-f9a07",
    storageBucket: "sscreenshare-f9a07.firebasestorage.app",
    messagingSenderId: "334641429960",
    appId: "1:334641429960:web:b4a17037ab372e1b0594fd",
    measurementId: "G-WS3GJVRJBH"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomId = "room123";
    const video = document.getElementById("video");

    let pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

    // Manejo de ICE candidates
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        const candidate = event.candidate.toJSON();
        db.ref(`${roomId}/candidates/${role}`).push(candidate);
      }
    };

    db.ref(`${roomId}/candidates/viewer`).on("child_added", snap => {
      if (role === "sender") {
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      }
    });

    db.ref(`${roomId}/candidates/sender`).on("child_added", snap => {
      if (role === "viewer") {
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      }
    });

    let role = null;

    async function startShare() {
      role = "sender";
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      video.srcObject = stream;

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      db.ref(`${roomId}/offer`).set(offer.toJSON());

      db.ref(`${roomId}/answer`).on("value", async snap => {
        if (snap.exists()) {
          const answer = new RTCSessionDescription(snap.val());
          await pc.setRemoteDescription(answer);
        }
      });
    }

    async function startViewer() {
      role = "viewer";
      db.ref(`${roomId}/offer`).once("value").then(async snap => {
        const offer = snap.val();
        if (!offer) return alert("Esperando que el emisor cree la sala...");

        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        db.ref(`${roomId}/answer`).set(answer.toJSON());
      });

      pc.ontrack = (event) => {
        video.srcObject = event.streams[0];
      };
    }
  </script>
</body>
</html>
